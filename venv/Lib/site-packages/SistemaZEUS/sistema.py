from SistemaZEUS.conv_mp3 import conversao
import os
from pytube import YouTube, Playlist  
import requests


class Sistema:
    def remove_dir(caminho= ''):
        if caminho != '':
            dir = os.listdir(caminho)
           
            for file in dir:
                try:
                    os.remove(caminho+'/'+file)
                except:
                    pass
                

    def downloadYT(url, pasta, opcao):
        Sistema.remove_dir(os.path.abspath('./SistemadeDownload/downloadcache')) 
        from pytube import YouTube
        while True:
            try:
                link = url
                if link == 'n':
                    break
                
            except:
                print("O link que você digitou é invalido, tente novamente!")
                
            else:
                try:
                    yt = YouTube(link)
                except:
                    print("Não foi possivel acessar as informações do link")
                    
                else:
                    print(yt.title)
                    

                    local = os.path.abspath('./SistemadeDownload/downloadcache')
                   
                    name = str(len(os.listdir()))
                    
                    
                    if opcao == '1':
                        o = yt.streams.all()
                    
                        b = o[0].download(local)
                        
                        name2 = os.listdir(os.path.abspath('./SistemadeDownload/downloadcache'))
                        name3 = name2[0].replace('.mp4', '')
                        
                        try:
                            conversao(mp4 = os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]), mp3 = os.path.abspath(pasta+'/'+name3))
                        except:
                            os.remove(os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]))
                        else:
                            os.remove(os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]))
                        
                        

                    elif opcao == '2':
                        o = yt.streams.all()              
                        b = o[0].download(pasta)
                        
                        

                    elif opcao == '3':
                        o = yt.streams.all()
                    
                        b = o[0].download(local)
                        
                        name2 = os.listdir(os.path.abspath('./SistemadeDownload/downloadcache'))
                        name3 = name2[0].replace('.mp4', '')
                        
                        
                        conversao(mp4 = os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]), mp3 = os.path.abspath(pasta[0]+'/'+name3))
                        os.remove(os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]))
                        o[0].download(pasta[1])
                        
                        
                    
            
            Sistema.remove_dir(os.path.abspath('./SistemadeDownload/downloadcache'))
            break     
    
    def DownloadPlaylist(url, pasta, opcao):
        Sistema.remove_dir(os.path.abspath('./SistemadeDownload/downloadcache'))  
        while True:
            
            try:
                link = url
                
            except:
                print("O link que você digitou é invalido, tente novamente!")
                
            else:

                try:
                    from  pytube  import  Playlist                
                    pl  =  Playlist(link)
                    
                except:
                    print('erro')
                else:
                    local = os.path.abspath('./SistemadeDownload/downloadcache')


                   
                    
                    
                    if opcao == '1':
                        for video in pl.videos:
                            video.streams.first().download(local)
                        
                            name2 = os.listdir(os.path.abspath('./SistemadeDownload/downloadcache'))
                            name3 = name2[0].replace('.mp4', '')
                            
                            try:
                                conversao(mp4 = os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]), mp3 = os.path.abspath(pasta+'/'+name3))
                            except:
                                os.remove(os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]))
                            else:
                                os.remove(os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]))
                            
                       

                    elif opcao == '2':
                        for video in pl.videos:
                            video.streams.first().download(pasta)
                        
                       

                    elif opcao == '3':
                        for video in pl.videos:
                            video.streams.first().download(local)
                        
                            name2 = os.listdir(os.path.abspath('./SistemadeDownload/downloadcache'))
                            name3 = name2[0].replace('.mp4', '')
                            
                            
                            conversao(mp4 = os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]), mp3 =  pasta[0]+'/'+name3)
                            os.remove(os.path.abspath('./SistemadeDownload/downloadcache/'+name2[0]))
                            video.streams.first().download(pasta[1])
                            
                        
            break       
    

    def background2(link, nome):
        Sistema.remove_dir(os.path.abspath('./SistemadeDownload/downloadimagecache'))
        Sistema.remove_dir(os.path.abspath('./SistemadeDownload/downloadimage'))
        b = nome
        img_list = []
  
        img_list.append(requests.get(link))

        for i, img in enumerate(img_list): #converte imagens para bytes
            with open(f'./SistemadeDownload/downloadimage/atual.png', 'wb') as f: #wb = write byte
                f.write(img.content)
                break


    def background(link, tipo):
        
        if tipo == 'Um arq':
            try:
                yt = YouTube(link)
                image = yt.thumbnail_url
                titulo= yt.title
                Sistema.background2(image, titulo)
            except:
                return False
            else:
                return image
        elif tipo == 'Playlist':
            try:
                yt  =  Playlist(link)
                image = yt[0].thumbnail_url
                titulo= yt[0].title
                Sistema.background2(image, titulo)
            except:
                return False
            else:
                return image
        else:
            return False



    def titulo(link, tipo):
        Sistema.background(link, tipo)
        if tipo == 'Um arq':
            try:
                yt = YouTube(link)
                titulo = str(yt.title)
            except:
                return False
            else:
                return titulo
        elif tipo == 'Playlist':
            try:
                pl  =  Playlist(link)
                titulo = str(pl[0].title)
            except:
                return False
            else:
                return titulo
        else:
            return False

    
    def up_previw(link, tipo):
        Sistema.remove_dir(os.path.abspath('./SistemadeDownload/previsu'))
        pasta = os.path.abspath('./SistemadeDownload/previsu')

        try:
            if tipo == "Um arq":
                yt = YouTube(link)
                o = yt.streams.all()              
                b = o[0].download(pasta, filename= "vid")
                print(b)
            elif tipo == "Playlist":
                pl  =  Playlist(link)
                for video in pl.videos:
                    video.streams.first().download(pasta, filename= "vid")
                    break

            else:
                print('else')
                return False                
        except:
            print('erro')
            return False

        else: 
            return True            


if __name__ == "__main__":
    Sistema.up_previw('https://www.youtube.com/watch?v=a7cN-GBTPxM', 'Um arq')